---
layout: single
title: Умный дом --- общее описание
excerpt: Как я делаю умный ДубльДом дом на *RaspberryPi*, *Domoticz* и недорогих китайских устройствах *Sonoff*.
header:
  teaser: "/assets/posts/smart_home/thermostat.jpg"
categories:
- Умный дом
tags:
- умный дом
- raspberrypi
- domoticz
- sonoff
comments: true
share: true
related: true
toc: true
date: 2019-08-20 15:02 +0300
---
**Примечание:** эта заметка является <<программной>> и будет обновляться вместе с эволюцией системы умного дома. Также в нее будут добавляться ссылки на все следующие заметки по теме <<[Умный дом](/categories/#умный-дом)>>.
{: .notice--info}


## Вступление

У меня есть дача, состоящая из двух типовых домов <<ДубльДом>> второй серии --- ДД 65 и ДД 43. Сразу как я их купил, я задумался о том, как организовать электрическое отопление так, чтобы оно работало относительно автономно (чтобы дом не промерзал зимой и отогревался к приезду). Немного поизучав рынок электрических конвекторов понял, что лучше сделаю всю систему управления домом сам, так как это интереснее и универсальнее, чем просто покупать отдельные решения под конкретные задачи. Чтобы не забыть, как я это сделал и для тех, кому интересно, захотел зафиксировать все в заметках. 

Мое решение для умного дома не является обязательно оптимальным по какому-либо параметру, просто я сделал *так* --- возможно разумно будет сделать что-то по другому, но мне *так* было удобнее.

{% include figure image_path="/assets/posts/smart_home/snegiri_floorplan.png" caption="Дашборд умного дома (*в работе*)" class="align-center" %}

В этой <<программной>> заметке я расскажу об основных элементах (оборудовании и программном обеспечении), которые я использовал для развертывания умного дома. О нюансах установки и использования конкретных элементов я планирую написать отдельно.

## Спецификация

### Сервер --- железки

Все, что касается железок, на которых развернута платформа умного дома.

![RaspberryPi и UPS][]{: .align-right }
- *[RaspberryPi 3B+][]* --- одноплатный компьютер, на котором все крутится, покупался на [AliExpress][RaspberryPi] примерно за 2500 руб.
- *UPS-18650* --- источник бесперебойного питания для *RaspberryPi* на случай кратковременного отключения электричества, работает на двух пальчиковых литиевых аккумуляторах 18650, в комлекте с вентилятором для охлаждения процессора, [AliExpress][UPS], примерно 2500 руб.
- *Импульсный блок питания* --- блок питания на DIN-рейку напряжением 5В и максимальной силой тока 5А (для стабильной работы RaspberryPi рекомендуется 3А, блок выбирался с запасом для подключения дополнительной периферии), [AliExpress][Power], около 900 руб.
- *USB-хаб* --- хаб на 7 портов для разводки питания на *RaspberryPi* и другие устройства от блока питания, [AliExpress][Hub], около 300 руб.
- *iPad 2* --- старый *iPad* с треснувшей платой, однако вполне работоспособный в стационарном положении, покупался когда-то новым в США. Используется как настенный пульт управления системой.

### Сервер --- программное обеспечение

Основные программы, которые установлены на *RaspberryPi* и обеспечивают логическое взаимодействие всех устройств умного дома.

![График температуры в Domoticz](/assets/posts/smart_home/domoticz_charts.png)
{: .align-right}

- *[Domoticz][]* --- мощная, но при этом довольно простая для новичка платформа для умного дома. В общем-то я ее и выбрал из-за показавшейся мне простоты установки и начала работы. У нее достаточно крутая кривая обучения и привыкания на начальном этапе по сравнению с другими, рассматриваемыми мною на этапе выбора платформами (*OpenHab*, *Home Assistant*), что конечно компенсируется меньшими возможностями по кастомизации. При этом в *Domoticz* реализованы достаточно удобные и понятные инструменты автоматизации и настраивания взаимодействия различных домашних устройств (начиная от визуального языка программирования *Blokly* и заканчивая очень удобным специально разработанным для *Domoticz* скриптовым языком *[dzVents][]*, который написан на основе *Lua*). Функционал дополнительно расширяется плагинами.
- *[Mosquitto][]* --- *[MQTT][]*-брокер. Весь обмен сообщениями между устройствами и *Domoticz* я стараюсь настраивать с помощью *MQTT*-телеграм. Это компактный асинхронный протокол передачи данных, который работает поверх *TCP/IP*. Работает очень быстро и надежно. Как правило, отклик с момента нажатия кнопки на телефоне, до изменения статуса конечного устройства практически мгновенный (в любом случае  намного быстрее, чем, например, если реализовывать тот же обмент через *HTTP*-реквесты).
- *[PM2][]* ---  удобный диспетчер процессов, работающий на   *Node.js* (и собственно написанный для приложений *Node.js*), который позволяет много чего интересного, в т.ч. поддерживать запущенные приложения в рабочем состоянии и перезагружать их без простоев. У меня отвечает за бесперебойную работу *Node-RED*, *HomeBridge* и обратный туннель *ssh* для пробрасывания портов через многочисленные межсетевые экраны и *NAT*-ы и обеспечения доступа к *Domoticz* из интернета.
- *[Node-RED][]* ---  платформа для визуального программирования потоков данных от устройств к устройству. Удобно использовать для отладки *MQTT*, а также для конвертирования телеграм *MQTT* от некоторых устройств в формат, который понимает *Domoticz*.
- *[HomeBridge][]* --- обеспечивает поддержку эппловского протокола для умных устройств *HomeKit*, что позволяет транслировать устройства из *Domoticz* в стандартные   *iOS* и *MacOS* приложения *Дом* и управлять устройствами голосовыми сообщениями c *Siri*. Обмен сообщениями также может быть настроен по пртоколу *MQTT*.

### Организация подсети и доступа из интернета

Организация взаимодействия всех устройств умного дома в отдельной *Wi-Fi* сети и настройка доступа к *Domoticz* из интернета.

![TP-Link MR3020](/assets/posts/smart_home/tplink.png)
{: .align-right}

- *TP-Link MR3020* --- легендарный дорожный беспроводной *Wi-Fi* роутрер, который покупался еще в 2012 году, когда встретить в номере отеля розетку *RJ45* было куда проще, чем работающий *Wi-Fi*. Последнее время валялся без дела, в виду чего был пристроен в качестве выделенного роутера под задачи умного дома. Очень скоро однако выяснилось, что стандартная прошивка не может нормально поддерживать больше 10, кажется, подключенных устройств, и была заменена на специально разработанную на базе *OpenWRT* для этого роутера прошивку *[Peppy Snowdrop 2.4][]*. С тех пор работает идеально.
- *[Zomro.com](https://zompro.com)*  --- самый дешевый виртуальный сервер ($0,99/месяц), который в контексте умного дома используется для доступа к *Domoticz* из интернета, а также для еще ряда других задач, не связанных с умным домом.
- *[Freenom.com](https://freenomm.com)* --- поставщик бесплатных доменов, используется для получения доменного имени для виртуального сервера и последующей настройки доступа к *Domoticz*  из интернета по защищенному протоколу *HTTPS*.

### Устройства и датчики

В настоящий момент в *Domoticz* у меня зарегистрировано более 120 различных устройств (но сюда также включены и различные виртуальные устройства, которые помогают выстроить логику работы и взаимодествие физических устройств).

![Sonoff Basic](/assets/posts/smart_home/sonoff.png)
{: .align-right}

- *[Sonoff][]* --- китайский производитель недорогих и качесвенных умных устройств, работающих на микроконтроллере *ESP8266*, имеет официальный магазин на *AliExpress*, что облегчает взаимодействие. Чтобы устройства *Sonoff* идеально работали с *Domoticz* я на них заливаю прошивку *[Tasmota][]* --- очень гибкая и функциональная прошивка для устройств на базе микроконтроллера *ESP8266*. Ниже перечислены, только те модели *Sonoff*, которые есть непосредственно у меня:
  - *Sonoff Basic/Dual* - умные *Wi-Fi* переключатели с одним (*Basic*) или двумя (*Dual*) выводами под полезную нагрузку с максимальным током 10А. Для тех у кого есть сомнения по соображениям пожарной безопасности, на Ютюбе есть канал электрика Джона Ворда, который протестировал многие из устройств под запредельной нагрузкой (например, [тестировние *Basic* с чайником на 2.8 кВт](https://www.youtube.com/watch?v=wHjlYswMUts)). Цена примерно 500-700 руб./шт.
  - *Sonoff TH16 и датчики температуры/влажности* --- умный Wi-Fi переключатель с разъемом для подключения датчиков температуры/влажности и выводом под полезную нагрузку с максимальным током 15А. Я использую датчики *Si7021*, т.к. они достаточно точные и не намного дороже аналогов, представленных в магазине *Sonoff*. В принципе датчики температуры/влажности можно напрямую припаять к имеющимся контактам у более дешевых моделей *Basic* (я делал так пару раз, когда не было под рукой *TH16*). Цена примерно 700 руб./шт. + 300 руб./датчик.
  - *Sonoff Pow* --- умный *Wi-Fi* переключатель под нагрузку с максимальным током 15A и весьма точным измерителем тока для контроля потребления мощности отдельными приборами. Цена примерно 850 руб./шт.
  - *Sonoff T1 EU* --- умные *Wi-Fi* выключатели света (на 1, 2 и 3 тумблера), которые монтируются в стандартное место для выключателя, максимальный ток 2А на вывод. К недостаткам я бы отнес сенсорное управление --- предпочел бы нажимные кнопки, которые проще нащупать и не вызывают трудностей у гостей, однако следует отметить очень хорошую чувствительность сенсоров. Цена примерно 1200-1300 руб./шт.
  - *PIR Sensor* --- инфракрасный датчик движения, работающий от двух пальчиковых батареек АА на радиочастоте 433МГц. Из четырех купленных один оказался бракованным и стрелял безостановочно. Цена примерно 800 руб./шт.
  - *Sonoff RF Bridge* --- передатчик, который принимает радиосигналы на частоте 433МГц и отправляет соответствующую MQTT-телеграму брокеру. Цена примерно 800 руб./шт.
- *[Netatmo Welcome][]* --- веб-камера с приятным дизайном, распознаванием лиц и уведомлениями о непрошенных гостях. Помимо своего собственного мобильного приложения от *Netatmo*, также можно встроить в *Domoticz* и получать картинку в *[Pilot](/умный%20дом/smart-home/#мобильные-приложения)*. Стоимость около 15000 руб.
- *[IQAir AirVisual Pro][]* --- дорогой швейцарский измеритель качества воздуха с аккумулятором для мобильности и *API* для интеграции. Подробно можно почитать в [обзоре](https://victorborisov.livejournal.com/301674.html) от Виктора Борисова. Цена примерно 20000 руб.
- *[HN-PM1/3F][]* --- *Wi-Fi* измеритель мощности электроэнергии на 3 фазы, заявленная точность 1%, максимальный ток на линию 100A, поддерживает протокол *MQTT*. Цена примерно 5000 руб.

### Мобильные приложения

Мобильные приложения для работы с *Domoticz* и *RaspberryPi*.

![Pilot, экран "Избранное"](/assets/posts/smart_home/pilot.png)
{: .align-right}

- *[Дом][]* --- стандартное приложение для работы с умными устройствами от Эппл. Практически все необходимые устройства *Domoticz* можно подружить с помощью *HomeBridge*. Позволяет управлять умным домом голосовыми сообщениями с *Siri*.
- *[Pilot Home Control][]* --- красивое и функциональное приложение для работы с *Domoticz*. Поддерживает все устройства, сцены, группы, камеры, можно посмотреть логи. Пока не очень хорошо реализованы графики, но приложение развивается. Цена полной версии 699 руб.
- *[Termius][]* --- удобный *ssh*-клиент для удаленного подключения к *RaspberryPi*. Мне хватает бесплатной версии.

## Теперь подробности

Планы по дальнейшим заметкам по теме умного дома и ссылки:

- Как перепрошить переключатель *Sonoff* без конвертора *USB-Serial* (*в планах*).
- Как подключить камеру *Netatmo Welcome* к *Domoticz* (*в планах*).
- Виртуальный самообучающийся термостат для *Domoticz* (*в планах*)
- Как сделать план дома для дашборда *Domoticz* (*в планах*).
- ...
- PROFIT!

[Дом]: https://apps.apple.com/ru/app/%D0%B4%D0%BE%D0%BC/id1110145103
[Pilot Home Control]: https://apps.apple.com/ru/app/pilot-home-control/id902546368
[Termius]: https://apps.apple.com/ru/app/termius-ssh-client/id549039908
[MQTT]: http://mqtt.org/
[HN-PM1/3F]: http://pm.h-net.ru/
[IQAir AirVisual Pro]: https://www.airvisual.com/air-quality-monitor
[Netatmo Welcome]: https://www.netatmo.com/en-eu/security/cam-indoor
[Tasmota]: https://github.com/arendst/Sonoff-Tasmota/wiki
[Sonoff]: https://sonoff.ru.aliexpress.com/
[Peppy Snowdrop 2.4]: https://acs-house.ru/tag/peppy-snowdrop/
[Node-RED]: https://nodered.org/
[Homebridge]: https://homebridge.io/
[PM2]: https://pm2.io/
[Domoticz]: http://www.domoticz.com/
[dzVents]: https://www.domoticz.com/wiki/DzVents:_next_generation_LUA_scripting
[Mosquitto]: https://mosquitto.org/
[RaspberryPi 3B+]: https://www.raspberrypi.org/
[RaspberryPi]: https://ru.aliexpress.com/wholesale?catId=0&initiative_id=AS_20190819120458&SearchText=raspberry+pi+3+model+b&switch_new_app=y
[UPS]: https://ru.aliexpress.com/item/32955634965.html?spm=a2g0s.9042311.0.0.274233edj0ZfCg
[Power]: https://ru.aliexpress.com/item/32305665411.html?spm=a2g0s.9042311.0.0.274233edvfsc0e
[Hub]: https://ru.aliexpress.com/item/32955096863.html?spm=a2g0s.9042311.0.0.274233edBpgCSn
[RaspberryPi и UPS]: /assets/posts/smart_home/ups.png "RaspberryPi и UPS-18650"
